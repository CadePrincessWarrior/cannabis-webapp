<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Delta Product Compliance Verification</title>
  <style>
    /* ====== Your existing CSS (unchanged) ====== */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:#0a0a0a; color:#e0e0e0; min-height:100vh; overflow-x:hidden; }
    .container { max-width:1200px; margin:0 auto; padding:20px; }
    header { background:linear-gradient(135deg,#1a1a1a 0%,#2d2d2d 100%); padding:30px 0; margin-bottom:40px; position:relative; overflow:hidden; }
    header::before { content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%; background:radial-gradient(circle, rgba(76,175,80,0.1) 0%, transparent 70%); animation:pulse 4s ease-in-out infinite; }
    @keyframes pulse { 0%,100% { transform:scale(1); opacity:0.5; } 50% { transform:scale(1.1); opacity:0.8; } }
    h1 { text-align:center; font-size:2.5em; background:linear-gradient(45deg,#4CAF50,#81C784); -webkit-background-clip:text; -webkit-text-fill-color:transparent; position:relative; z-index:1; }
    .subtitle { text-align:center; color:#999; margin-top:10px; position:relative; z-index:1; }
    .error-banner { display:none; background:#f44336; color:white; padding:15px; text-align:center; margin-bottom:20px; border-radius:8px; }
    .nav-buttons { text-align:center; margin-bottom:30px; }
    .nav-btn { background:#2a2a2a; color:white; border:1px solid #444; padding:10px 20px; border-radius:8px; cursor:pointer; margin:0 10px; transition:all 0.3s ease; }
    .nav-btn:hover { background:#333; border-color:#4CAF50; }
    .nav-btn.active { background:#4CAF50; border-color:#4CAF50; }
    .form-section { background:#1a1a1a; border-radius:16px; padding:30px; margin-bottom:30px; box-shadow:0 10px 30px rgba(0,0,0,0.5); border:1px solid #333; transition:all 0.3s ease; }
    .form-section:hover { transform:translateY(-2px); box-shadow:0 15px 40px rgba(0,0,0,0.7); border-color:#4CAF50; }
    .section-title { font-size:1.5em; margin-bottom:20px; color:#4CAF50; display:flex; align-items:center; gap:10px; }
    .section-title::before { content:''; display:inline-block; width:4px; height:24px; background:linear-gradient(180deg,#4CAF50,#81C784); border-radius:2px; }
    .form-group { margin-bottom:20px; }
    label { display:block; margin-bottom:8px; color:#bbb; font-weight:500; }
    input[type="text"], input[type="date"], textarea, select { width:100%; padding:12px 16px; background:#0a0a0a; border:1px solid #333; border-radius:8px; color:#e0e0e0; font-size:16px; transition:all 0.3s ease; }
    input:focus, textarea:focus, select:focus { outline:none; border-color:#4CAF50; box-shadow:0 0 0 3px rgba(76,175,80,0.1); }
    .image-upload-section { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-top:20px; }
    .image-upload-box { background:#0a0a0a; border:2px dashed #333; border-radius:12px; padding:40px 20px; text-align:center; cursor:pointer; transition:all 0.3s ease; position:relative; overflow:hidden; }
    .image-upload-box:hover { border-color:#4CAF50; background:#111; transform:scale(1.02); }
    .image-upload-box.has-image { border-style:solid; border-color:#4CAF50; background:#0f1f0f; }
    .upload-icon { font-size:3em; margin-bottom:10px; opacity:0.5; }
    .upload-label { font-size:1.1em; color:#999; margin-bottom:5px; }
    .upload-hint { font-size:0.9em; color:#666; }
    .preview-image { max-width:100%; max-height:150px; border-radius:8px; margin-top:10px; }
    .cannabinoid-list { display:flex; flex-wrap:wrap; gap:10px; margin-top:20px; }
    .cannabinoid-item { background:#2a2a2a; padding:10px 20px; border-radius:8px; border:1px solid #444; display:flex; align-items:center; gap:10px; transition:all 0.3s ease; }
    .cannabinoid-item:hover { background:#333; border-color:#4CAF50; }
    .remove-btn { background:#f44336; color:white; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center; transition:all 0.3s ease; }
    .remove-btn:hover { background:#d32f2f; transform:scale(1.1); }
    .add-btn { background:linear-gradient(45deg,#4CAF50,#81C784); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-size:16px; font-weight:500; transition:all 0.3s ease; display:inline-flex; align-items:center; gap:8px; }
    .add-btn:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(76,175,80,0.3); }
    .flags-section { background:#1f1a1a; border:1px solid #3a2a2a; border-radius:12px; padding:20px; margin-top:30px; }
    .flag-item { display:flex; align-items:flex-start; gap:10px; margin-bottom:15px; padding:15px; background:#2a1a1a; border-radius:8px; border-left:4px solid transparent; transition:all 0.3s ease; }
    .flag-item.warning { border-left-color:#ff9800; }
    .flag-item.error   { border-left-color:#f44336; }
    .flag-item.success { border-left-color:#4CAF50; }
    .flag-icon { font-size:1.5em; }
    .submit-section { text-align:center; margin-top:40px; }
    .submit-btn { background:linear-gradient(45deg,#4CAF50,#81C784); color:white; border:none; padding:16px 48px; border-radius:12px; cursor:pointer; font-size:18px; font-weight:600; transition:all 0.3s ease; position:relative; overflow:hidden; }
    .submit-btn::before { content:''; position:absolute; top:50%; left:50%; width:0; height:0; border-radius:50%; background:rgba(255,255,255,0.2); transform:translate(-50%,-50%); transition:width 0.6s,height 0.6s; }
    .submit-btn:hover::before { width:300px; height:300px; }
    .submit-btn:hover { transform:translateY(-3px); box-shadow:0 10px 30px rgba(76,175,80,0.4); }
    .submit-btn:disabled { background:#666; cursor:not-allowed; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; backdrop-filter:blur(5px); }
    .modal-content { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#1a1a1a; border-radius:16px; padding:30px; max-width:500px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,0.8); border:1px solid #333; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    .products-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; margin-top:20px; }
    .product-card { background:#1a1a1a; border:1px solid #333; border-radius:12px; padding:20px; transition:all 0.3s ease; cursor:pointer; }
    .product-card:hover { transform:translateY(-2px); border-color:#4CAF50; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
    .product-card h3 { color:#4CAF50; margin-bottom:10px; }
    .product-meta { color:#999; font-size:0.9em; margin-bottom:10px; }
    .status-badge { display:inline-block; padding:4px 12px; border-radius:20px; font-size:0.85em; font-weight:600; margin-top:10px; }
    .status-badge.compliant { background:#4CAF50; }
    .status-badge.issues    { background:#f44336; }
    .loading { text-align:center; padding:40px; color:#666; }
    @media (max-width:768px) { .row { grid-template-columns:1fr; } h1 { font-size:2em; } .image-upload-section { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header><div class="container"><h1>Delta Product Compliance Verification</h1><p class="subtitle">Automated COA & Packaging Verification System</p></div></header>

  <div class="container">
    <div id="errorBanner" class="error-banner">❌ Something went wrong. Please try again.</div>
    <div class="nav-buttons">
      <button class="nav-btn active" onclick="showView('form')">Add New Product</button>
      <button class="nav-btn" onclick="showView('list')">View All Products</button>
      <button class="nav-btn" onclick="exportData()">Export Data</button>
    </div>

    <div id="formView">
      <form id="productForm">
        <!-- (your form content unchanged) -->
        <div class="submit-section">
          <button type="submit" class="submit-btn" id="submitBtn">Verify Compliance & Save Product</button>
        </div>
      </form>
    </div>

    <div id="listView" style="display:none">
      <div class="form-section">
        <h2 class="section-title">All Products</h2>
        <div id="productsList" class="products-grid"><div class="loading">Loading products…</div></div>
      </div>
    </div>
  </div>

  <div id="successModal" class="modal">
    <div class="modal-content">
      <h2 style="color:#4CAF50; margin-bottom:20px;">✓ Product Saved Successfully</h2>
      <p>The product has been verified and saved to the shared database.</p>
      <button class="add-btn" onclick="closeModal()">Add Another Product</button>
    </div>
  </div>

  <script>
    // ← UPDATED Apps Script URL
    const SHEET_API = 'https://script.google.com/macros/s/AKfycbyo0VDZP198BzccV-3lDC8SKQlLqqFBCZOYw6j3EoZm_fpCPl7sUKo2qIEyR-GymUe_/exec';

    let packagingCannabinoids = [], coaCannabinoids = [], uploadedImages = {}, coaFileData = null, complianceIssues = [];

    window.addEventListener('DOMContentLoaded', () => {
      if (location.hash === '#list') showView('list');
    });

    function showView(view) {
      document.getElementById('errorBanner').style.display = 'none';
      document.getElementById('formView').style.display = view==='form' ? 'block' : 'none';
      document.getElementById('listView').style.display = view==='list' ? 'block' : 'none';
      if (view==='list') loadProducts();
    }

    function handleImageUpload(input, key) {
      if (!input.files[0]) return;
      const reader = new FileReader();
      reader.onload = e => {
        const img = document.getElementById(`preview-${key}`);
        img.src = e.target.result; img.style.display='block';
        uploadedImages[key] = e.target.result;
      };
      reader.readAsDataURL(input.files[0]);
    }

    function handleCOAUpload(input) {
      if (!input.files[0]) return;
      const reader = new FileReader();
      reader.onload = e => { coaFileData = e.target.result; };
      reader.readAsDataURL(input.files[0]);
    }

    function addCannabinoid() { /* … unchanged … */ }
    function addCOACannabinoid() { /* … unchanged … */ }
    function updateCannabinoidsList() { /* … */ }
    function updateCOACannabinoidsList() { /* … */ }
    function removeCannabinoid(i) { /* … */ }
    function removeCOACannabinoid(i) { /* … */ }
    function checkCompliance() { /* … */ }

    // CRUD helpers (simple POST → no headers)
    async function loadFromGoogleSheets() {
      try {
        const r = await fetch(`${SHEET_API}?action=read`);
        if (!r.ok) throw new Error(r.statusText);
        const { products } = await r.json();
        return products;
      } catch {
        document.getElementById('errorBanner').style.display='block';
        return [];
      }
    }
    async function saveToGoogleSheets(data) {
      try {
        const r = await fetch(`${SHEET_API}?action=create`, {
          method: 'POST',
          body: JSON.stringify(data)
        });
        if (!r.ok) throw new Error(r.statusText);
        return (await r.json()).success;
      } catch {
        document.getElementById('errorBanner').style.display='block';
        return false;
      }
    }
    async function updateProduct(data) { /* … */ }
    async function deleteProduct(id)   { /* … */ }

    document.getElementById('productForm').addEventListener('submit', async e => {
      e.preventDefault();
      document.getElementById('errorBanner').style.display = 'none';
      const btn = document.getElementById('submitBtn');
      btn.disabled = true; btn.textContent = 'Saving…';

      const data = {
        id: Date.now().toString(),
        timestamp: new Date().toISOString(),
        brand: document.getElementById('brand').value,
        product: document.getElementById('product').value,
        sku: document.getElementById('sku').value,
        batchNumber: document.getElementById('batchNumber').value,
        coaDate: document.getElementById('coaDate').value,
        labName: document.getElementById('labName').value,
        packagingCannabinoids,
        coaCannabinoids,
        imageURLs: uploadedImages,
        coaFileURL: coaFileData || '',
        complianceIssues
      };

      const ok = await saveToGoogleSheets(data);
      if (ok) document.getElementById('successModal').style.display='block';
      else    document.getElementById('errorBanner').style.display='block';

      btn.disabled = false;
      btn.textContent = 'Verify Compliance & Save Product';
    });

    async function loadProducts()    { /* … */ }
    async function viewProduct(id)  { /* … */ }
    async function exportData()     { /* … */ }
    function closeModal()            { /* … */ }

    // Expose
    window.showView            = showView;
    window.handleImageUpload   = handleImageUpload;
    window.handleCOAUpload     = handleCOAUpload;
    window.addCannabinoid      = addCannabinoid;
    window.addCOACannabinoid   = addCOACannabinoid;
    window.removeCannabinoid   = removeCannabinoid;
    window.removeCOACannabinoid= removeCOACannabinoid;
    window.loadProducts        = loadProducts;
    window.viewProduct         = viewProduct;
    window.exportData          = exportData;
    window.closeModal          = closeModal;
  </script>
</body>
</html>
