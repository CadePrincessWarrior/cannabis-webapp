<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Delta Product Compliance Verification</title>
  <style>
    /* (Your full CSS from before) */
    /* ... */
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Delta Product Compliance Verification</h1>
      <p class="subtitle">Automated COA & Packaging Verification System</p>
    </div>
  </header>

  <div class="container">
    <div id="errorBanner" class="error-banner">
      ❌ Something went wrong. Please try again or check your connection.
    </div>
    <div class="nav-buttons">
      <button class="nav-btn active" onclick="showView('form')">Add New Product</button>
      <button class="nav-btn" onclick="showView('list')">View All Products</button>
      <button class="nav-btn" onclick="exportData()">Export Data</button>
    </div>

    <!-- Form View -->
    <div id="formView">
      <form id="productForm">
        <!-- (All your form sections…) -->

        <div class="submit-section">
          <button type="submit" class="submit-btn" id="submitBtn">
            Verify Compliance & Save Product
          </button>
        </div>
      </form>
    </div>

    <!-- List View -->
    <div id="listView" style="display:none">
      <div class="form-section">
        <h2 class="section-title">All Products</h2>
        <div id="productsList" class="products-grid">
          <div class="loading">Loading products…</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="modal">
    <div class="modal-content">
      <h2 style="color:#4CAF50; margin-bottom:20px;">✓ Product Saved Successfully</h2>
      <p>The product has been verified and saved to the shared database.</p>
      <button class="add-btn" onclick="closeModal()">Add Another Product</button>
    </div>
  </div>

  <script>
    // ← Updated to your new Google Sheets URL:
    const SHEET_API = 'https://script.google.com/macros/s/AKfycbyo0VDZP198BzccV-3lDC8SKQlLqqFBCZOYw6j3EoZm_fpCPl7sUKo2qIEyR-GymUe_/exec';

    let packagingCannabinoids = [], coaCannabinoids = [], uploadedImages = {}, coaFileData = null, complianceIssues = [];

    window.addEventListener('DOMContentLoaded', () => {
      if (window.location.hash === '#list') showView('list');
    });

    function showView(view) {
      document.getElementById('errorBanner').style.display = 'none';
      document.getElementById('formView').style.display = view==='form' ? 'block' : 'none';
      document.getElementById('listView').style.display = view==='list' ? 'block' : 'none';
      if (view==='list') loadProducts();
    }

    function handleImageUpload(input, key) {
      if (!input.files[0]) return;
      const reader = new FileReader();
      reader.onload = e => {
        const img = document.getElementById(`preview-${key}`);
        img.src = e.target.result; img.style.display='block';
        uploadedImages[key] = e.target.result;
      };
      reader.readAsDataURL(input.files[0]);
    }

    function handleCOAUpload(input) {
      if (!input.files[0]) return;
      const reader = new FileReader();
      reader.onload = e => { coaFileData = e.target.result; };
      reader.readAsDataURL(input.files[0]);
    }

    function addCannabinoid() { /* … */ }
    function addCOACannabinoid() { /* … */ }
    function updateCannabinoidsList() { /* … */ }
    function updateCOACannabinoidsList() { /* … */ }
    function removeCannabinoid(i) { /* … */ }
    function removeCOACannabinoid(i) { /* … */ }
    function checkCompliance() { /* … */ }

    // CRUD helpers (no headers on POST → simple request)
    async function loadFromGoogleSheets() {
      try {
        const r = await fetch(`${SHEET_API}?action=read`);
        if (!r.ok) throw new Error(r.statusText);
        const { products } = await r.json();
        return products;
      } catch (e) {
        document.getElementById('errorBanner').style.display = 'block';
        return [];
      }
    }
    async function saveToGoogleSheets(data) {
      try {
        const r = await fetch(`${SHEET_API}?action=create`, {
          method: 'POST',
          body: JSON.stringify(data)
        });
        if (!r.ok) throw new Error(r.statusText);
        return (await r.json()).success;
      } catch {
        document.getElementById('errorBanner').style.display = 'block';
        return false;
      }
    }
    async function updateProduct(data) { /* … similar … */ }
    async function deleteProduct(id) { /* … similar … */ }

    // Form submission
    document.getElementById('productForm').addEventListener('submit', async e => {
      e.preventDefault();
      document.getElementById('errorBanner').style.display='none';
      const btn = document.getElementById('submitBtn');
      btn.disabled = true; btn.textContent='Saving…';

      const data = {
        id:Date.now().toString(),
        timestamp:new Date().toISOString(),
        brand:document.getElementById('brand').value,
        product:document.getElementById('product').value,
        sku:document.getElementById('sku').value,
        batchNumber:document.getElementById('batchNumber').value,
        coaDate:document.getElementById('coaDate').value,
        labName:document.getElementById('labName').value,
        packagingCannabinoids,
        coaCannabinoids,
        imageURLs:uploadedImages,
        coaFileURL:coaFileData||'',
        complianceIssues
      };

      const ok = await saveToGoogleSheets(data);
      if (ok) document.getElementById('successModal').style.display='block';
      else    document.getElementById('errorBanner').style.display='block';

      btn.disabled=false; btn.textContent='Verify Compliance & Save Product';
    });

    async function loadProducts() { /* … */ }
    async function viewProduct(id) { /* … */ }
    async function exportData() { /* … */ }

    function closeModal() { /* … */ }

    // Expose
    window.showView            = showView;
    window.handleImageUpload   = handleImageUpload;
    window.handleCOAUpload     = handleCOAUpload;
    window.addCannabinoid      = addCannabinoid;
    window.addCOACannabinoid   = addCOACannabinoid;
    window.removeCannabinoid   = removeCannabinoid;
    window.removeCOACannabinoid= removeCOACannabinoid;
    window.loadProducts        = loadProducts;
    window.viewProduct         = viewProduct;
    window.exportData          = exportData;
    window.closeModal          = closeModal;
  </script>
</body>
</html>
